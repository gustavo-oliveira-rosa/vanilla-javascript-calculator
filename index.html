<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora Simples — Vanilla JS</title>

    <style>
      :root{
        --bg:#0b1020;
        --surface:#0f172a;
        --border:#1e293b;
        --muted:#94a3b8;
        --text:#e2e8f0;
        --accent:#22d3ee;
        --accent-2:#0ea5e9;
        --shadow:0 12px 30px rgba(0,0,0,.35);
        --radius:18px;
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
        background:
          radial-gradient(900px 700px at 110% -10%, rgba(14,165,233,.18), transparent 60%),
          radial-gradient(600px 500px at -10% 20%, rgba(34,211,238,.12), transparent 60%),
          var(--bg);
        color:var(--text);
        display:grid; place-items:center; padding:24px;
      }

      .calc{
        width:min(420px, 100%);
        background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)) , var(--surface);
        border:1px solid var(--border);
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        overflow:hidden;
      }

      .calc__header{padding:18px 18px 0}
      .calc__title{margin:0 0 6px; font-size:clamp(1.1rem, 1.4rem, 1.6rem)}
      .calc__subtitle{margin:0 0 12px; color:var(--muted); font-size:.95rem}

      .screen{display:flex; flex-direction:column; gap:6px; padding:14px 18px 18px}
      .screen__expr{min-height:22px; color:var(--muted); letter-spacing:.4px; word-break:break-all}
      .screen__result{font-size:2.4rem; line-height:1.2; word-break:break-all}

      .keys{display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; padding:18px}

      .btn{
        -webkit-tap-highlight-color:transparent;
        appearance:none; border:1px solid var(--border);
        border-radius:14px; padding:14px 12px; font-size:1.1rem; font-weight:700;
        background:#0b1229; color:#dbeafe; cursor:pointer; box-shadow:var(--shadow);
        transition: transform .04s ease, background .2s ease, border-color .2s ease;
      }
      .btn:active{transform:translateY(1px)}
      .btn:focus{outline:2px solid rgba(34,211,238,.6); outline-offset:2px}

      .btn--op{background:#0b1633}
      .btn--eq{background:linear-gradient(135deg, var(--accent-2), var(--accent)); color:#041016; border-color:transparent}
      .btn--wide{grid-column:span 2}

      .calc__footer{padding:8px 18px 16px; color:var(--muted); font-size:.85rem; text-align:center}
      .kbd{display:inline-block; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#0b1229; color:#dbeafe; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    </style>
  </head>
  <body>
    <main class="calc" aria-label="Calculadora simples">
      <header class="calc__header">
        <h1 class="calc__title">Calculadora Simples</h1>
        <p class="calc__subtitle">HTML + CSS + JavaScript (Vanilla) — suporta teclado.</p>
      </header>

      <section class="screen" aria-live="polite">
        <div id="expr" class="screen__expr" aria-label="Expressão">0</div>
        <div id="result" class="screen__result" aria-label="Resultado">0</div>
      </section>

      <section class="keys" aria-label="Teclado da calculadora">
        <button class="btn btn--op" data-action="clear" aria-label="Limpar">C</button>
        <button class="btn btn--op" data-action="backspace" aria-label="Apagar">⌫</button>
        <button class="btn btn--op" data-op="%" aria-label="Porcentagem">%</button>
        <button class="btn btn--op" data-op="/" aria-label="Dividir">÷</button>

        <button class="btn" data-num="7">7</button>
        <button class="btn" data-num="8">8</button>
        <button class="btn" data-num="9">9</button>
        <button class="btn btn--op" data-op="*" aria-label="Multiplicar">×</button>

        <button class="btn" data-num="4">4</button>
        <button class="btn" data-num="5">5</button>
        <button class="btn" data-num="6">6</button>
        <button class="btn btn--op" data-op="-" aria-label="Subtrair">−</button>

        <button class="btn" data-num="1">1</button>
        <button class="btn" data-num="2">2</button>
        <button class="btn" data-num="3">3</button>
        <button class="btn btn--op" data-op="+" aria-label="Somar">+</button>

        <button class="btn btn--wide" data-num="0">0</button>
        <button class="btn" data-dot="," aria-label="Decimal">,</button>
        <button class="btn btn--eq btn--wide" data-action="equals" aria-label="Igual">=</button>
      </section>

      <footer class="calc__footer">
        Dicas: use o teclado (números, <span class="kbd">+</span> <span class="kbd">-</span> <span class="kbd">*</span> <span class="kbd">/</span> <span class="kbd">%</span>),
        <span class="kbd">Enter</span> (=), <span class="kbd">Backspace</span> (⌫) e <span class="kbd">Esc</span> (C).
      </footer>
    </main>

    <script>
      // Elementos de UI (visor)
      const $expr = document.getElementById('expr');
      const $result = document.getElementById('result');

      // Estado mínimo da aplicação
      const state = {
        current: '0',   // número que o usuário está digitando (string)
        tokens: [],     // ex.: ["12", "+", "3", "*", "4"]
        lastWasOp: false // para evitar operações duplicadas
      };

      // Utilitário: atualiza o visor (expressão + resultado parcial)
      function render(){
        // Monta a expressão para EXIBIÇÃO (não usada para cálculo)
        const displayParts = [...state.tokens];
        if(state.current !== '') displayParts.push(state.current);
        const exprText = displayParts.join(' ').replaceAll('*','×').replaceAll('/', '÷');
        $expr.textContent = exprText.length ? exprText : '0';

        // Monta os tokens para CÁLCULO (evita passar string vazia e gerar NaN)
        const evalTokens = [...state.tokens];
        if(state.current !== '') evalTokens.push(normalizeNumber(state.current));

        // CORREÇÃO: Remove operadores do final se a expressão estiver incompleta
        while (evalTokens.length > 0 && ['+','-','*','/','%'].includes(evalTokens[evalTokens.length - 1])) {
          evalTokens.pop();
        }

        const val = safeEvaluate(evalTokens);
        // Se não há valor calculável ainda, mostra 0 (ou o número em digitação)
        $result.textContent = (val !== null ? val : (state.current || '0'));
      }

      // Utilitário: inserir dígito (0-9)
      function inputDigit(d){
        if(state.current === '0') state.current = d;
        else state.current += d;
        state.lastWasOp = false;
        render();
      }

      // Utilitário: inserir ponto decimal
      function inputDot(){
        if(!state.current.includes('.')){
          state.current += '.';
          render();
        }
      }

      // Utilitário: aplicar operação (+ - * / %)
      function inputOp(op){
        // Se não há número corrente e não há tokens, usa 0 como primeiro número
        if(state.current === '' && state.tokens.length === 0){
          state.current = '0';
        }
        
        // Se acabou de usar um operador, troca o operador em vez de empilhar
        if(state.lastWasOp && state.tokens.length){
          state.tokens[state.tokens.length - 1] = op;
        } else {
          // Empilha o número corrente antes do operador
          if(state.current === '') {
            // CORREÇÃO: Se não há número corrente, usa o último resultado
            const lastResult = safeEvaluate([...state.tokens]);
            if(lastResult !== null) {
              state.current = String(lastResult);
              state.tokens = [];
            } else {
              state.current = '0';
            }
          }
          state.tokens.push(normalizeNumber(state.current));
          state.tokens.push(op);
          state.current = '';
          state.lastWasOp = true;
        }
        render();
      }

      // Utilitário: calcular (=)
      function equals(){
        // CORREÇÃO: Verifica se há algo para calcular
        if(state.current === '' && state.tokens.length === 0) return;
        
        // Fecha a expressão com o número atual
        if(state.current === '') {
          // Se não há número atual, usa o último resultado ou 0
          const lastResult = safeEvaluate([...state.tokens.slice(0, -1)]);
          state.current = lastResult !== null ? String(lastResult) : '0';
          state.tokens = [];
        } else {
          state.tokens.push(normalizeNumber(state.current));
        }
        
        const value = safeEvaluate(state.tokens);
        if(value !== null){
          state.current = String(value);
          state.tokens = [];
          state.lastWasOp = false;
        }
        render();
      }

      // Utilitário: limpar tudo (C)
      function clearAll(){
        state.current = '0';
        state.tokens = [];
        state.lastWasOp = false;
        render();
      }

      // Utilitário: apagar último caractere (⌫)
      function backspace(){
        if(state.current === '' && state.tokens.length){
          // Se não há número corrente, puxa o último token caso seja número
          const last = state.tokens.pop();
          if(['+','-','*','/','%'].includes(last)){
            // Se era um operador, desfaz e volta a permitir número
            state.lastWasOp = false;
          } else {
            state.current = String(last);
          }
        } else {
          // Remove um caractere do número corrente
          state.current = state.current.length > 1 ? state.current.slice(0, -1) : '0';
        }
        render();
      }

      // Conversão de vírgula visual para ponto interno
      function normalizeNumber(str){
        return str.replace(',', '.');
      }

      // Parser/avaliador simples com precedência de operadores
      function safeEvaluate(tokens){
        try{
          if(!tokens || tokens.length === 0) return 0;

          // CORREÇÃO: Remove operadores do final
          while (tokens.length > 0 && ['+','-','*','/','%'].includes(tokens[tokens.length - 1])) {
            tokens = tokens.slice(0, -1);
          }

          if(tokens.length === 0) return 0;

          // 1) Converte strings numéricas e separa operadores
          const seq = tokens.map(t => ['+','-','*','/','%'].includes(t) ? t : Number.parseFloat(String(t)));

          // CORREÇÃO: Verifica se há NaN nos números
          if(seq.some(item => typeof item === 'number' && isNaN(item))){
            return null;
          }

          // 2) Primeiro passa: resolve *, / e % da esquerda pra direita
          const high = [];
          let i = 0;
          while(i < seq.length){
            const item = seq[i];
            if(item === '*' || item === '/' || item === '%'){
              const a = high.pop();
              const b = seq[i+1];
              // CORREÇÃO: Verifica se os operandos são válidos
              if(typeof a !== 'number' || typeof b !== 'number') return null;
              
              let r = 0;
              if(item === '*') r = a * b;
              if(item === '/') r = b === 0 ? NaN : a / b;
              if(item === '%') r = a % b;
              
              if(isNaN(r)) return null;
              high.push(r);
              i += 2;
            } else {
              high.push(item);
              i += 1;
            }
          }

          // 3) Segundo passa: resolve + e -
          let acc = high[0];
          for(let j=1; j<high.length; j+=2){
            const op = high[j];
            const val = high[j+1];
            // CORREÇÃO: Verifica se os operandos são válidos
            if(typeof acc !== 'number' || typeof val !== 'number') return null;
            
            if(op === '+') acc += val;
            if(op === '-') acc -= val;
          }

          // Evita -0 visual
          const clean = Object.is(acc, -0) ? 0 : acc;
          // Limita casas decimais para evitar 0.30000000004 (erro de ponto flutuante)
          return Number.parseFloat(clean.toFixed(12));
        }catch(e){
          return null;
        }
      }

      // ========== Ligações com a interface (cliques) ==========
      document.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button');
        if(!btn) return;

        if(btn.dataset.num){
          inputDigit(btn.dataset.num);
          return;
        }
        if(btn.dataset.dot !== undefined){
          inputDot();
          return;
        }
        if(btn.dataset.op){
          inputOp(btn.dataset.op);
          return;
        }
        if(btn.dataset.action === 'clear'){
          clearAll();
          return;
        }
        if(btn.dataset.action === 'backspace'){
          backspace();
          return;
        }
        if(btn.dataset.action === 'equals'){
          equals();
          return;
        }
      });

      // ========== Suporte ao teclado ==========
      document.addEventListener('keydown', (e)=>{
        const k = e.key;
        if(/[0-9]/.test(k)) return void inputDigit(k);
        if(k === ',' || k === '.') return void inputDot();
        if(['+','-','*','/','%'].includes(k)) return void inputOp(k);
        if(k === 'Enter' || k === '=') return void equals();
        if(k === 'Backspace') return void backspace();
        if(k === 'Escape') return void clearAll();
      });

      // Exibe o estado inicial
      render();
    </script>
  </body>
</html>
